# 标准化AI提示词工程方案

## 设计理念

为单个源代码文件的中文注释生成设计一套标准化、高效的提示词工程方案，确保从输入原始代码到输出带有完整中文注释的文件的整个过程能够顺利执行。

## 支持的编程语言

本方案支持以下编程语言，每种语言都有专门的提示词模板：

- **Python** - `python_prompts.md`
- **JavaScript/TypeScript** - `javascript_prompts.md`
- **Java** - `java_prompts.md`
- **C++** - `cpp_prompts.md`
- **Go** - `go_prompts.md`
- **Rust** - `rust_prompts.md`

## 动态分层架构系统

### 🎯 基于项目理解程度的动态调整模式
**设计理念**：根据AI对项目的理解程度动态调整提示词的详细程度和技术深度
**目标用户**：所有中文开发者，特别适合团队协作和长期项目维护

```
项目理解建立 → 渐进式代码分析 → 动态提示词调整 → 高质量注释生成
```

### 三阶段动态流程

#### 阶段一：项目理解建立（新对话开始时）
**目标**：建立AI对项目的全面理解基线

**核心步骤**：
1. **项目结构分析**
   - 分析项目文件结构和配置文件
   - 识别技术栈、框架和工具链
   - 理解项目的整体架构模式

2. **业务领域理解**
   - 分析README和文档内容
   - 识别核心业务实体和流程
   - 理解领域特定术语和概念

3. **编码规范识别**
   - 分析现有代码的命名约定
   - 识别注释风格和文档规范
   - 理解错误处理和测试模式

4. **理解程度评估**
   - AI自我评估对项目各方面的理解程度（1-5分）
   - 建立后续提示词调整的基准线

#### 阶段二：渐进式代码分析
**目标**：通过分析不同复杂度的代码，逐步加深对项目的理解

**动态策略**：
- **低理解程度（<2分）**：从简单代码片段开始，重点学习项目风格
- **中等理解程度（2-3分）**：分析中等复杂度代码，理解业务逻辑
- **高理解程度（≥4分）**：直接分析复杂代码，深入架构层面

#### 阶段三：高质量注释生成
**目标**：基于建立的项目理解，生成高质量的中文注释

**动态调整原则**：
- **高理解程度**：使用项目特定的深度模板，包含业务价值和架构定位
- **中等理解程度**：使用标准详细模板，重点关注功能和实现
- **低理解程度**：使用基础通用模板，确保技术准确性

## 动态调整提示词系统

### 核心组件

1. **项目理解建立提示词** → `dynamic_prompt_system.md`
2. **渐进式代码分析提示词** → `dynamic_prompt_system.md`
3. **动态调整的专业模式提示词** → `dynamic_prompt_system.md`
4. **语言特定基础模板** → 各语言的 `*_prompts.md` 文件

### 动态调整特点

1. **智能感知**：AI能够感知自己对项目的理解程度
2. **自适应调整**：根据理解程度自动调整提示词详细程度
3. **渐进式学习**：通过分析代码逐步加深对项目的理解
4. **上下文优化**：动态调整上下文信息的提供量
5. **质量保证**：确保在任何理解程度下都能生成高质量注释

### 使用策略

- **新项目开始**：使用完整的三阶段流程建立项目理解
- **项目进行中**：基于已有理解程度选择合适的提示词模板
- **复杂代码**：自动升级到更详细的分析模式
- **简单代码**：使用简化的快速生成模式

## 动态调整执行流程

### 完整的三阶段流程

```
阶段1: 项目理解建立 → 阶段2: 渐进式代码分析 → 阶段3: 三步骤代码处理
```

#### 阶段3的三步骤代码处理流程

每个代码文件都需要经过以下标准化的三个步骤：

**第一步：清理原有注释**
- 移除源代码中所有现有的注释（包括行内注释、块注释、文档字符串等）
- 保留代码的核心逻辑和结构完全不变
- 确保移除注释后代码仍然语法正确且可执行
- 绝对不能修改任何变量名、函数名、类名或字符串字面量

**第二步：代码格式化**
- 根据对应编程语言的标准规范进行代码格式化
- 统一缩进、空格、换行等格式要素
- 优化代码布局和可读性
- 严格确保不修改任何标识符或字面量

**第三步：生成中文注释**
- 基于清理和格式化后的代码生成高质量中文注释
- 根据项目理解程度选择合适的注释详细程度
- 确保注释符合对应编程语言的文档规范
- 生成的注释应具有技术准确性和教育价值

#### 阶段1：项目理解建立
```python
def establish_project_understanding(project_info: dict) -> dict:
    """建立AI对项目的全面理解"""

    # 1. 项目分析提示词
    analysis_prompt = f"""
    你是世界级的软件架构师和代码分析专家。请分析以下项目：

    项目结构：{project_info['structure']}
    配置文件：{project_info['config']}
    README：{project_info['readme']}

    请从技术栈、架构模式、业务领域、编码规范、项目成熟度五个维度进行分析。
    """

    project_analysis = ai_client.generate(analysis_prompt)

    # 2. 理解程度确认
    confirmation_prompt = """
    基于你的分析，请评估你对以下方面的理解程度（1-5分）：
    1. 技术栈理解
    2. 架构理解
    3. 业务理解
    4. 规范理解

    请返回JSON格式的评分。
    """

    understanding_levels = ai_client.generate(confirmation_prompt)

    return {
        'analysis': project_analysis,
        'understanding_levels': understanding_levels
    }
```

#### 阶段2：渐进式代码分析
```python
def progressive_code_analysis(code: str, language: str, understanding: dict) -> dict:
    """根据理解程度进行渐进式代码分析"""

    overall_score = understanding['understanding_levels']['overall_score']

    if overall_score < 3.0:
        # 简单代码熟悉
        prompt = f"""
        让我们从简单代码开始熟悉项目风格：

        代码：
        ```{language}
        {code}
        ```

        请分析：命名约定、代码风格、注释风格、项目规范特点
        """
    else:
        # 复杂代码深入分析
        prompt = f"""
        基于对项目的理解，深入分析以下代码：

        代码：
        ```{language}
        {code}
        ```

        请分析：业务逻辑、设计模式、架构契合度、代码质量
        """

    return ai_client.generate(prompt)
```

#### 阶段3：高质量注释生成
```python
def generate_dynamic_comments(code: str, language: str, understanding: dict) -> str:
    """基于理解程度动态生成注释"""

    confidence_level = understanding['confidence_level']

    if confidence_level == 'high':
        # 高理解程度：项目特定深度模板
        prompt = f"""
        作为{understanding['project_name']}项目专家，为以下代码生成深度注释：

        项目背景：{understanding['context_summary']}

        代码：
        ```{language}
        {code}
        ```

        要求：业务价值、架构定位、实现细节、设计考虑、使用指导、扩展建议
        """

    elif confidence_level == 'medium':
        # 中等理解程度：标准详细模板
        prompt = f"""
        为{language}项目代码生成详细注释：

        代码：
        ```{language}
        {code}
        ```

        要求：功能说明、参数解释、返回值、实现要点、使用示例、注意事项
        """

    else:
        # 低理解程度：基础通用模板
        prompt = f"""
        为以下{language}代码生成基础中文注释：

        代码：
        ```{language}
        {code}
        ```

        要求：功能概述、参数说明、返回值、关键逻辑、使用方法
        """

    return ai_client.generate(prompt)
```

### 智能流程控制
```python
class DynamicPromptController:
    def __init__(self):
        self.project_understanding = None
        self.code_history = []

    def process_code_with_dynamic_adjustment(self, code: str, language: str,
                                           project_info: dict = None) -> str:
        """动态调整的完整代码处理流程"""

        # 如果是新项目或没有项目理解，建立项目理解
        if not self.project_understanding and project_info:
            self.project_understanding = self.establish_project_understanding(project_info)

        # 如果有项目理解，进行渐进式分析
        if self.project_understanding:
            analysis = self.progressive_code_analysis(code, language, self.project_understanding)
            self.code_history.append(analysis)

            # 更新理解程度
            self.update_understanding_level()

        # 生成高质量注释
        annotated_code = self.generate_dynamic_comments(code, language, self.project_understanding)

        return annotated_code

    def update_understanding_level(self):
        """基于代码分析历史更新理解程度"""
        history_bonus = min(len(self.code_history) * 0.1, 1.0)

        for aspect in self.project_understanding['understanding_levels']:
            current_score = self.project_understanding['understanding_levels'][aspect]
            self.project_understanding['understanding_levels'][aspect] = min(current_score + history_bonus, 5.0)
```

## 使用指南

### 动态调整系统使用方法

#### 方法1：完整三阶段流程（推荐用于新项目）

**第一步：建立项目理解**
```
1. 收集项目信息（文件结构、配置文件、README等）
2. 使用项目分析提示词让AI分析项目
3. 确认AI对项目各方面的理解程度
4. 建立项目理解基线
```

**第二步：渐进式代码分析**
```
1. 从简单代码开始，让AI熟悉项目风格
2. 逐步引入复杂代码，加深业务理解
3. AI会根据理解程度自动调整分析深度
4. 建立代码分析历史，提升理解程度
```

**第三步：高质量注释生成**
```
1. AI根据当前理解程度选择合适的提示词模板
2. 动态调整上下文信息的详细程度
3. 生成符合项目规范的高质量中文注释
4. 确保注释与项目整体风格一致
```

#### 方法2：快速使用（适用于已有项目理解）

```
直接使用动态调整指令：

"基于你对当前项目的理解程度，为以下代码生成合适的中文注释：
[粘贴你的代码]"

AI会自动：
- 评估当前对项目的理解程度
- 选择合适的注释详细程度
- 生成符合项目规范的注释
```

#### 方法3：传统单文件处理（适用于独立代码片段）

```
使用语言特定的基础模板：

"请使用Python专业模式为以下代码生成中文注释：
[粘贴你的代码]"
```

### 动态调整效果示例

#### 低理解程度时的注释（理解程度 < 2分）
```python
def authenticate_user(username: str, password: str) -> Optional[User]:
    """
    用户身份验证：验证用户凭据并返回用户对象

    参数:
        username (str): 用户名
        password (str): 密码

    返回:
        Optional[User]: 验证成功返回用户对象，失败返回None
    """
```

#### 高理解程度时的注释（理解程度 ≥ 4分）
```python
def authenticate_user(username: str, password: str) -> Optional[User]:
    """
    用户身份验证服务：电商平台核心安全组件

    业务价值：
        作为用户管理微服务的核心认证入口，确保只有合法用户能够访问系统资源。
        支持电商平台的用户登录、会话管理和权限控制业务流程。

    架构定位：
        位于用户服务层(UserService)，实现DDD架构中的身份认证领域服务。
        与用户仓储(UserRepository)和密码哈希服务(PasswordHasher)协作。

    实现细节：
        1. 通过用户名查询用户实体，避免无效的密码验证开销
        2. 使用安全的密码哈希验证，防止时序攻击和彩虹表攻击
        3. 采用短路求值优化性能，用户不存在时立即返回

    参数:
        username (str): 用户登录名，遵循平台命名规范(3-20字符)
        password (str): 明文密码，将与存储的bcrypt哈希值比较

    返回:
        Optional[User]: 认证成功返回完整用户实体，失败返回None
                       用户实体包含用户ID、角色权限等后续业务所需信息

    使用指导:
        - 调用前应进行输入验证和频率限制
        - 返回None时不应透露具体失败原因（用户名不存在 vs 密码错误）
        - 建议配合审计日志记录认证尝试

    扩展建议:
        - 可扩展支持多因素认证(MFA)
        - 可集成OAuth2.0等第三方认证
        - 考虑添加账户锁定机制防止暴力破解
    """
```

### 质量检查标准

#### 动态质量标准
- ✅ **理解程度匹配**：注释详细程度与AI理解程度相匹配
- ✅ **项目一致性**：注释风格与项目整体规范保持一致
- ✅ **业务相关性**：高理解程度时包含业务价值和架构定位
- ✅ **技术准确性**：所有技术描述准确无误
- ✅ **中文质量**：表达自然流畅，术语使用准确
- ✅ **教育价值**：根据理解程度提供相应的学习价值
- ✅ **实用性**：提供有价值的使用指导和扩展建议

## 动态调整AI提示词系统详解

### 设计理念

基于AI模型对当前项目的理解程度，动态调整提示词的详细程度和技术深度，实现渐进式的项目理解建立和高质量注释生成。

### 项目分析提示词模板

#### 项目理解建立提示词
```
你是世界级的软件架构师和代码分析专家。我需要你深入分析一个项目，为后续的代码注释生成建立完整的项目理解基线。

## 任务
请分析以下项目信息，建立全面的项目理解：

## 项目信息
- 项目根目录：{project_root}
- 主要文件结构：
```
{project_structure}
```

- 配置文件内容：
```
{config_files}
```

- README文档：
```
{readme_content}
```

## 分析要求
请从以下维度进行全面分析：

### 1. 技术栈识别
- 主要编程语言和版本
- 使用的框架和库
- 构建工具和依赖管理
- 数据库和中间件

### 2. 架构模式分析
- 整体架构风格（MVC、微服务、分层等）
- 设计模式的使用
- 模块间的依赖关系
- 数据流和控制流

### 3. 业务领域理解
- 项目的业务目标和核心功能
- 主要的业务实体和关系
- 业务流程和用例场景
- 领域特定的术语和概念

### 4. 编码规范识别
- 命名约定和代码风格
- 注释风格和文档规范
- 错误处理模式
- 测试策略和覆盖度

### 5. 项目成熟度评估
- 代码质量和复杂度
- 文档完整性
- 技术债务情况
- 维护和扩展性

## 输出格式
请按以下结构输出分析结果：

```json
{
  "project_understanding": {
    "tech_stack": {
      "primary_language": "语言名称",
      "frameworks": ["框架列表"],
      "tools": ["工具列表"],
      "databases": ["数据库列表"]
    },
    "architecture": {
      "pattern": "架构模式",
      "design_patterns": ["设计模式列表"],
      "module_structure": "模块结构描述"
    },
    "business_domain": {
      "purpose": "业务目标",
      "core_entities": ["核心实体列表"],
      "key_processes": ["关键流程列表"],
      "domain_terms": ["领域术语列表"]
    },
    "coding_standards": {
      "naming_convention": "命名约定",
      "comment_style": "注释风格",
      "error_handling": "错误处理模式"
    },
    "maturity_level": {
      "code_quality": "质量评级",
      "documentation": "文档完整度",
      "complexity": "复杂度评级"
    }
  }
}
```

请开始分析。
```

#### 项目理解确认提示词
```
基于你刚才的项目分析，请确认你对以下方面的理解程度（1-5分，5分为完全理解）：

1. **技术栈理解** (1-5分)：对项目使用的技术栈的熟悉程度
2. **架构理解** (1-5分)：对项目整体架构和设计模式的理解程度
3. **业务理解** (1-5分)：对项目业务领域和核心功能的理解程度
4. **规范理解** (1-5分)：对项目编码规范和文档风格的理解程度

请按以下格式回答：
```json
{
  "understanding_levels": {
    "tech_stack": 分数,
    "architecture": 分数,
    "business": 分数,
    "standards": 分数
  },
  "confidence_summary": "整体理解程度的简要说明"
}
```

这将帮助我为你调整后续代码注释生成的提示词详细程度。
```

### 渐进式代码分析提示词

#### 简单代码熟悉提示词（理解程度 < 3分时使用）
```
现在让我们从一些简单的代码开始，帮助你熟悉这个项目的代码风格和约定。

## 任务
请分析以下简单代码片段，重点关注：
1. 命名约定和代码风格
2. 注释风格（如果有的话）
3. 错误处理方式
4. 与项目整体风格的一致性

## 代码片段
```{language}
{simple_code}
```

## 分析要求
- 识别代码中体现的项目规范
- 注意变量命名、函数命名的模式
- 观察代码组织和结构特点
- 理解这段代码在项目中的作用

请简要分析这段代码，并说明你从中学到的项目特点。
```

#### 复杂代码深入分析提示词（理解程度 >= 3分时使用）
```
基于你对项目的理解，现在分析一段更复杂的业务逻辑代码。

## 当前项目理解基线
- 技术栈：{tech_stack_summary}
- 架构模式：{architecture_pattern}
- 业务领域：{business_domain}
- 编码规范：{coding_standards}

## 任务
请深入分析以下复杂代码，重点关注：
1. 业务逻辑的实现方式
2. 设计模式的应用
3. 与项目架构的契合度
4. 代码质量和最佳实践

## 代码内容
```{language}
{complex_code}
```

## 分析要求
- 解释代码的业务价值和技术实现
- 识别使用的设计模式和架构原则
- 评估代码质量和改进空间
- 理解代码在整个系统中的定位

请提供详细的代码分析。
```

## 三步骤代码处理流程详解

### 概述

为确保生成高质量的中文注释代码文件，我们设计了一个标准化的三步骤处理流程。这个流程确保每个代码文件都经过统一的清理、格式化和注释生成过程，最终输出具有一致质量的带注释代码文件。

### 第一步：清理原有注释

#### 目标
移除源代码中所有现有的注释，为生成新的中文注释做准备。

#### 具体操作
1. **移除所有注释类型**
   - 行内注释（如 `//`、`#`）
   - 块注释（如 `/* */`、`"""`）
   - 文档注释（如 `///`、`/** */`、JSDoc等）
   - 特殊注释（如 `//!`、`#!`）

2. **保持代码完整性**
   - 保留代码的核心逻辑和结构完全不变
   - 确保移除注释后代码仍然语法正确
   - 确保代码可以正常编译和执行
   - 绝对不能修改任何功能性代码

3. **严格限制**
   - 绝对不能修改任何变量名、函数名、类名
   - 绝对不能修改任何字符串字面量和数值常量
   - 绝对不能添加、删除或修改任何功能性代码
   - 绝对不能改变代码的执行结果

### 第二步：代码格式化

#### 目标
根据对应编程语言的标准规范进行代码格式化，提升代码的可读性和一致性。

#### 语言特定格式化规则
- **Python**: 遵循PEP 8标准，使用4个空格缩进
- **JavaScript/TypeScript**: 使用2个空格缩进，现代ES6+风格
- **Java**: 使用4个空格缩进，遵循Java代码规范
- **C++**: 使用4个空格缩进，现代C++风格
- **Go**: 使用gofmt标准格式
- **Rust**: 使用rustfmt标准格式

#### 格式优化要素
- 统一缩进和空格使用
- 优化大括号和换行位置
- 添加适当的空行分隔
- 提升代码布局的可读性

#### 安全验证
- 严格确保不修改任何标识符
- 严格确保不修改任何字面量
- 确保代码逻辑完全一致
- 只修改格式和布局

### 第三步：生成中文注释

#### 目标
基于清理和格式化后的代码，生成高质量的中文注释。

#### 动态调整策略
根据项目理解程度选择合适的注释详细程度：

1. **高理解程度（≥4分）**
   - 包含业务价值说明和架构定位
   - 详细的设计考虑和实现要点
   - 使用指导和扩展建议
   - 项目特定的术语和概念

2. **中等理解程度（2-3分）**
   - 详细的功能说明和参数解释
   - 实现要点和使用示例
   - 注意事项和最佳实践

3. **低理解程度（<2分）**
   - 基础的功能概述和参数说明
   - 关键逻辑解释和使用方法
   - 确保技术准确性

## 代码格式优化原则

### 核心原则

**安全第一**：
- 绝对不能修改任何代码逻辑
- 绝对不能修改变量名、函数名、类名
- 绝对不能添加、删除或修改功能性代码
- 绝对不能改变代码的执行结果

**格式优化**：
- 统一代码风格和缩进
- 改善代码布局和可读性
- 添加适当的空白行分隔
- 优化括号和运算符格式

**教育导向**：
- 让代码更容易阅读和理解
- 体现良好的编程习惯
- 便于学习者掌握代码规范
- 提升整体学习体验

### 严格禁止的操作

**绝对不能做的**：
❌ 修改变量名、函数名、类名
❌ 修改字符串字面量内容
❌ 修改数值常量
❌ 添加或删除任何语句
❌ 修改条件表达式
❌ 修改循环逻辑
❌ 修改函数参数
❌ 修改返回值
❌ 修改导入语句
❌ 修改任何业务逻辑

**只能做的**：
✅ 调整缩进和空格
✅ 调整大括号位置
✅ 添加空白行分隔
✅ 统一代码风格
✅ 优化代码布局

## 质量检查框架

### 质量检查维度

**第一维度：技术准确性**
- 代码功能理解是否正确？
- 技术术语使用是否准确？
- 算法和数据结构描述是否精确？
- 性能和复杂度分析是否合理？

**第二维度：内容完整性**
- 是否覆盖了所有重要的功能点？
- 参数和返回值说明是否完整？
- 异常情况是否得到充分说明？
- 使用场景和限制是否明确？

**第三维度：教育价值**
- 是否提供了有价值的学习内容？
- 解释深度是否适合目标读者？
- 是否包含了设计思路和最佳实践？
- 是否激发了进一步学习的兴趣？

**第四维度：中文表达质量**
- 语言是否自然流畅？
- 术语使用是否规范一致？
- 结构是否清晰易读？
- 是否符合中文技术写作规范？

**第五维度：实用性**
- 是否提供了可操作的指导？
- 示例是否恰当和有效？
- 注意事项是否实用？
- 是否有助于避免常见错误？

### 分层质量检查流程

#### 第一层：基础准确性检查
- 函数/类的核心功能理解验证
- 参数类型和用途确认
- 返回值含义和类型检查
- 异常处理逻辑验证

#### 第二层：深度内容检查
- 算法逻辑分析准确性
- 设计模式识别正确性
- 性能特征描述合理性
- 安全考虑完整性

#### 第三层：教育价值评估
- 学习目标明确性
- 知识点覆盖完整性
- 难度梯度合理性
- 实践指导有效性

#### 第四层：语言质量审核
- 中文表达自然性
- 技术术语准确性
- 逻辑结构清晰性
- 阅读体验流畅性


